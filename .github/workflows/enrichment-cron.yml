name: Enrichment Processing Cron

on:
  schedule:
    # Run every 5 minutes (GitHub Actions minimum)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-enrichment:
    runs-on: ubuntu-latest
    steps:
      - name: Process enrichment batches
        run: |
          # Call the endpoint multiple times to process more rows per run
          # 10 calls x 50 rows = 500 rows per 5-minute run = 6,000 rows/hour
          for i in {1..10}; do
            echo "Batch $i..."
            response=$(curl -s "https://dataflow-pi.vercel.app/api/cron/process-enrichment?secret=${{ secrets.CRON_SECRET }}")
            echo "$response"
            # If no active jobs, stop early
            if echo "$response" | grep -q '"processed":0'; then
              echo "No more rows to process, stopping early"
              break
            fi
            sleep 20
          done
