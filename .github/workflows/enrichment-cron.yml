name: Enrichment Processing Cron

on:
  schedule:
    # Run every 5 minutes (GitHub Actions minimum)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-enrichment:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Process enrichment batches
        run: |
          # Each call now processes continuously for ~55 seconds
          # With 5-min intervals, we do 5 calls = ~4.5 minutes of processing
          # At ~50 rows per batch, ~1 batch per call = 50 rows per call
          # 5 calls x 50 rows = 250 rows per 5-min run = 3,000 rows/hour

          APP_URL="${{ vars.VERCEL_APP_URL || 'https://dataflow-pi.vercel.app' }}"
          echo "Starting enrichment processing at $(date)"

          for i in {1..5}; do
            echo ""
            echo "=== Call $i at $(date) ==="
            response=$(curl -s --max-time 65 "${APP_URL}/api/cron/process-enrichment?secret=${{ secrets.CRON_SECRET }}")
            echo "$response"

            # If no active jobs, stop early
            if echo "$response" | grep -q '"message":"No active jobs"'; then
              echo "No active jobs, stopping"
              break
            fi

            # Small delay between calls
            sleep 5
          done

          echo ""
          echo "Finished at $(date)"
